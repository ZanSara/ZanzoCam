{% extends "base.html" %}

{% block content %}
    <p>
    Inserisci qua sotto i dati del WiFi e i dati necessari per la
    configurazione iniziale.
    </p>
    
    <p>
    Questi dati potranno essere cambiati in seguito utilizzando il file di 
    configurazione salvato sul server. La webcam scarichera' il file aggiornato
    appena prima di scattare una nuova foto.
    </p>

    <div id="page">

        <div class="sheet">
            <form id="config" method="POST" action="/configure/wifi">
                <h3>WiFi:</h3>
                <label for="wifi_ssid">Nome della rete (SSID):</label>
                <input type="text" name="wifi_ssid" value="{{ wifi_data.ssid }}">
                
                <label for="wifi_password">Password:</label>
                <div class="row">
                    <input type="password" name="wifi_password" value="{{ wifi_data.password }}" required> 
                    <button onclick="toggle_password(this)" type="button">Mostra</button> 
                </div>
                <div class="center">
                    <button id="configure-wifi" class="button">Configura il WiFi</button> 
                </div>
                {% if feedback_sheet_name == "wifi" %}
                <p {% if feedback_type == "positive" %}style="color:green;"{% else %}style="color:red;"{% endif %}>{{ feedback }}</p>
                {% endif %}
            </form>
        </div>

        <div class="sheet">
            <form id="config" method="POST" action="/configure/server">
                <div class="row">
                    <h3>Server:</h3>
                    <label class="toggle">
                        <input type="radio" value="HTTP" name="server_protocol" {% if server_data.protocol=="HTTP" %}checked{%endif%} onclick="javascript:toggle_server_protocol('HTTP')" style="display:none;">
                        <span class="label">HTTP</span>
                    </label>
                    <label class="toggle">
                        <input type="radio" value="FTP" name="server_protocol" {% if server_data.protocol=="FTP" %}checked{%endif%} onclick="javascript:toggle_server_protocol('FTP')"  style="display:none;">
                        <span class="label">FTP</span>
                    </label>
                </div>            
                <div id="ftp-vars" style="display: none; flex-direction:column!important;">
                    <div class="row">
                        <div class="column">
                            <label>Hostname:</label>
                            <input type="text" placeholder="example.com" id="server-hostname" name="server_hostname" value="{{ server_data.hostname }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="column">
                            <label class="label-inline">Sottocartella (se necessaria):</label>
                            <input type="text" name="server_subfolder" value="{{ server_data.subfolder }}">
                        </div>
                        <div class="column">
                            <label class="label-inline">Avanzate:</label>
                            <div style="padding: 10px;">
                                <input type="checkbox" name="server_tls" {% if server_data.tls %}checked{%endif%}>
                                <label class="label-inline">Usa TLS</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="http-vars" style="display: none;">
                    <label for="server_url">URL del server:</label>
                    <input type="text" name="server_url" value="{{ server_data.url }}">
                </div>
                
                <label for="server_username">Username del server (se necessario):</label>
                <input type="text" placeholder="username"  name="server_username" value="{{ server_data.username }}">
                
                <label for="server_password">Password del server (se necessaria):</label>
                <div class="row">
                    <input type="password" name="server_password" value="{{ server_data.password }}"> 
                    <button onclick="toggle_password(this)" type="button">Mostra</button> 
                </div>
            
                <div class="center">
                    <button id="configure-server" class="button">Configura Dati Server</button> 
                </div>

            </form>
            {% if feedback_sheet_name == "server" %}
            <p {% if feedback_type == "positive" %}style="color:green;"{% else %}style="color:red;"{% endif %}>{{feedback }}</p>
            {% endif %}
        </div>

        <div class="sheet">
            <div class="row">
                <h3>Hotspot:</h3>
                <label class="toggle">
                    <input type="radio" value="ON" name="hotspot_allowed" {% if not hotspot_value or hotspot_value=="ON" %}checked{%endif%} onchange="javascript:turnHotspotON()">
                    <span class="label">ON</span>
                </label>
                <label class="toggle">
                    <input type="radio" value="OFF" name="hotspot_allowed" {% if hotspot_value=="OFF" %}checked{%endif%} onchange="javascript:turnHotspotOFF()">
                    <span class="label">OFF</span>
                </label>
                <br>
            </div>
            <p><b>NOTA BENE:</b> Questo switch serve per permettere a ZANZOCAM di generare o meno un hotspot quando perde contatto
            con qualunque rete WiFi nota. Questo switch NON attiva l'hotspot se ZANZOCAM è gia' in grado di collegarsi
            con un'altra rete WiFi o è collegata via rete Ethernet.<br>
            Si consiglia di selezionare ON durante il setup della webcam, e di selezionare OFF una volta che il sistema e'
            completamente funzionante.</p>
        </div>
        
        <div class="sheet">
            <div class="row">
                <h3>Webcam:</h3>
                <a href="/webcam-setup" id="setup-webcam" class="button" type="button" style="margin: auto 0;">Setup Webcam</a>
            </div>
        </div>

        

    </div>
    
    
    <script>
    function toggle_password(button) {
        if( button.innerHTML == 'Mostra' ) {
            button.innerHTML = 'Nascondi'
            button.previousElementSibling.type="text";
        } else {
            button.innerHTML = 'Mostra'
            button.previousElementSibling.type="password";
        }
    }

    function toggle_server_protocol(value){
        // Toggle http or ftp in the server section
        var http_block = document.getElementById("http-vars");
        var ftp_block = document.getElementById("ftp-vars");
        http_block.style.display = value==="HTTP" ? "block" : "none";
        ftp_block.style.display = value==="FTP" ? "block" : "none";
    }
    toggle_server_protocol("{{ server_data.protocol }}");
    
    
    function disableOnHotspot() {
        if(window.location.href.includes("10.0.0.5")){
            button = document.getElementById("setup-webcam");
            button.disabled = true;
            feedback = document.getElementById("feedback");
            feedback.innerHTML = "Per scattare la foto di prova, riavvia il Raspberry "+
			"e connettiti ad esso tramite il WiFi, invece che usare l'hotspot.";
        }
    }
    
    function turnHotspotOFF() {
        confirmation = confirm("ATTENZIONE! Una volta premuto questo bottone, " +
              "ZANZOCAM smettera' di produrre il suo hotspot in caso di " +
              "assenza di WiFi.\n\n" +
              "Sei sicuro\a di voler proseguire?");
        if(confirmation){
            fetch("/configure/hotspot/OFF", {
                method:'POST',
            })
            .then(r => {
                alert("Modifica completata con successo.");
            }).catch(r => {
                alert("Qualcosa è andato storto! " +
                      "ZANZOCAM non è raggiungibile.");
            })   
        }
    }
    function turnHotspotON() {
        confirmation = confirm("ATTENZIONE! Una volta premuto questo bottone, " +
              "ZANZOCAM comincera' a produrre il suo hotspot in caso di " +
              "assenza di WiFi.\n\n" +
              "Sei sicuro\a di voler proseguire?");
        if(confirmation){
            fetch("/configure/hotspot/ON", {
                method:'POST',
            })
            .then(r => {
                alert("Modifica completata con successo.");
            }).catch(r => {
                alert("Qualcosa è andato storto! " +
                      "ZANZOCAM non è raggiungibile.");
            })   
        }
    }
    </script>
    
{% endblock %}
